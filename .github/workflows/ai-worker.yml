name: AI Worker Agent

on:
    workflow_dispatch:
        inputs:
            issue_number:
                description: "Issue number to execute"
                required: true

permissions:
    contents: write
    pull-requests: write
    issues: write
    repository-projects: write

jobs:
    work:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Install uv (for MCP tools)
              uses: astral-sh/setup-uv@v5

            - name: Intall dependencies
              run: npm install

            - name: Generate AI Rules
              run: npx rulesync generate

            # 0. PREPARE CONTEXT
            - name: Fetch Issue Details
              id: issue
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                  gh issue view ${{ github.event.inputs.issue_number }} --json title,body > issue.json
                  echo "title=$(jq -r .title issue.json)" >> $GITHUB_OUTPUT
                  # Handle multiline body safely with random delimiter
                  delimiter="$(openssl rand -hex 8)"
                  echo "body<<$delimiter" >> $GITHUB_OUTPUT
                  jq -r .body issue.json >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT

            - name: Debug Context
              env:
                  ISSUE_TITLE: ${{ steps.issue.outputs.title }}
              run: |
                  echo "Title: $ISSUE_TITLE"
                  echo "Body length: ${{ steps.issue.outputs.body }}" | wc -c

            # 1. ATOMIC PLANNING
            - name: Planning
              id: planning
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
                  ISSUE_TITLE: ${{ steps.issue.outputs.title }}
                  ISSUE_BODY: ${{ steps.issue.outputs.body }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: node tooling/ai-workers/plan.js

            # 2. EXECUTION LOOP
            - name: Development & Implementation
              if: steps.planning.outputs.needs_decomposition != 'true'
              id: developer
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
                  ISSUE_TITLE: ${{ steps.issue.outputs.title }}
                  METHODOLOGY: ${{ steps.planning.outputs.methodology }}
                  FILES: ${{ steps.planning.outputs.files }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: node tooling/ai-workers/develop.js

            - name: Commit Implementation
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add .
                  git commit -m "feat(ai): implementation of #${{ github.event.inputs.issue_number }}" || echo "No changes to commit"
                  git push

            # 3. VERIFICATION
            - name: Install Playwright Browsers
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: npx playwright install --with-deps

            - name: Run Related Tests
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: |
                  # Run tests with coverage
                  npx vitest run --coverage

            - name: Update Coverage Thresholds
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: npm run test:coverage:update

            # 4. SELF-REVIEW (Optional, usually on PR but here for immediate feedback)
            - name: Self-Review
              if: steps.planning.outputs.needs_decomposition != 'true'
              id: reviewer
              uses: google-github-actions/run-gemini-cli@v0.1.20
              with:
                  gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
                  gemini_model: "gemini-2.5-flash"
                  prompt: |
                      You are the Reviewer Agent.
                      Role: @reviewer-agent

                      Files changed: $(git diff --name-only origin/main)
                      Diff:
                      $(git diff origin/main)

                      Instruction: Audit this code. Output "APPROVED" if quality is high.

            # 5. SUBMIT & SYNC
            - name: Create Pull Request
              if: contains(steps.reviewer.outputs.text, 'APPROVED')
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  REVIEWER_TEXT: ${{ steps.reviewer.outputs.text }}
              run: |
                  gh pr create --title "feat: resolve issue #${{ github.event.inputs.issue_number }}" --body "Automated PR by AI Worker Agent. \n\nReviewer feedback: $REVIEWER_TEXT"

            - name: Sync Costs
              if: always()
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
                  PLANNING_INPUT_TOKENS: ${{ steps.planning.outputs.input_tokens || '0' }}
                  PLANNING_OUTPUT_TOKENS: ${{ steps.planning.outputs.output_tokens || '0' }}
                  DEVELOPER_INPUT_TOKENS: ${{ steps.developer.outputs.input_tokens || '0' }}
                  DEVELOPER_OUTPUT_TOKENS: ${{ steps.developer.outputs.output_tokens || '0' }}
                  REVIEWER_INPUT_TOKENS: ${{ steps.reviewer.outputs.prompt_token_count || '0' }}
                  REVIEWER_OUTPUT_TOKENS: ${{ steps.reviewer.outputs.candidates_token_count || '0' }}
              run: |
                  node tooling/ai-workers/sync.js

            - name: Mark Task as Paused on Failure
              if: failure() || cancelled()
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
              run: |
                  node tooling/ai-workers/sync.js --failed

            - name: Cleanup Temporary Files
              if: always()
              run: |
                  rm -f issue.json
