name: AI Worker Agent

on:
    workflow_dispatch:
        inputs:
            issue_number:
                description: "Issue number to execute"
                required: true

permissions:
    contents: write
    pull-requests: write
    issues: write
    repository-projects: write

jobs:
    work:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Install uv (for MCP tools)
              uses: astral-sh/setup-uv@v5
              with:
                  cache-dependency-path: ""

            - name: Intall dependencies
              run: npm ci || npm install

            - name: Generate AI Rules
              run: npx rulesync generate

            # 0. PREPARE CONTEXT
            - name: Fetch Issue Details
              id: issue
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                  gh issue view ${{ github.event.inputs.issue_number }} --json title,body > issue.json
                  echo "title=$(jq -r .title issue.json)" >> $GITHUB_OUTPUT
                  delimiter="$(openssl rand -hex 8)"
                  echo "body<<$delimiter" >> $GITHUB_OUTPUT
                  jq -r .body issue.json >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT

            - name: Prune Skills for Planning
              run: node tooling/ai-workers/prune-skills.js planning

            # 1. ATOMIC PLANNING (Autonomous Agent)
            - name: Planning
              id: planning
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
                  ISSUE_TITLE: ${{ steps.issue.outputs.title }}
                  ISSUE_BODY: ${{ steps.issue.outputs.body }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: node tooling/ai-workers/plan.js

            # 2. EXECUTION LOOP (Autonomous Agent)
            - name: Restore & Prune Skills for Development
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: |
                  npx rulesync generate
                  node tooling/ai-workers/prune-skills.js development

            - name: Development & Implementation
              if: steps.planning.outputs.needs_decomposition != 'true'
              id: developer
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
                  ISSUE_TITLE: ${{ steps.issue.outputs.title }}
                  ISSUE_BODY: ${{ steps.issue.outputs.body }}
                  METHODOLOGY: ${{ steps.planning.outputs.methodology }}
                  FILES: ${{ steps.planning.outputs.files }}
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: node tooling/ai-workers/develop.js

            - name: Finalize Work (Commit & Create PR)
              if: steps.planning.outputs.needs_decomposition != 'true'
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  
                  if [[ -z $(git status --porcelain) ]]; then
                    echo "No code changes detected. Skipping commit and PR."
                    exit 0
                  fi
                  
                  # Extract commit message if saved by agent
                  COMMIT_MSG="feat: resolve #$ISSUE_NUMBER (AI Agent)"
                  if [ -f .github/AI_COMMIT_MESSAGE ]; then
                    COMMIT_MSG=$(cat .github/AI_COMMIT_MESSAGE)
                  fi
                  
                  git add .
                  git commit -m "$COMMIT_MSG"
                  git fetch origin main
                  git pull --rebase origin main
                  git push --force-with-lease origin HEAD
                  
                  gh pr create --title "$COMMIT_MSG" --body "Automated PR by AI Worker Agent. Resolves #$ISSUE_NUMBER."

            # 3. VERIFICATION
            - name: Run Verification Tests
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: npm test

            - name: Update Coverage Thresholds
              if: steps.planning.outputs.needs_decomposition != 'true'
              run: npm run test:coverage:update

            - name: Sync Costs
              if: always()
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
                  PLANNING_INPUT_TOKENS: ${{ steps.planning.outputs.input_tokens || '0' }}
                  PLANNING_OUTPUT_TOKENS: ${{ steps.planning.outputs.output_tokens || '0' }}
                  DEVELOPER_INPUT_TOKENS: ${{ steps.developer.outputs.input_tokens || '0' }}
                  DEVELOPER_OUTPUT_TOKENS: ${{ steps.developer.outputs.output_tokens || '0' }}
              run: |
                  node tooling/ai-workers/sync.js

            - name: Mark Task as Paused on Failure
              if: failure() || cancelled()
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
                  ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
              run: |
                  node tooling/ai-workers/sync.js --failed

            - name: Cleanup Temporary Files
              if: always()
              run: |
                  rm -f issue.json
