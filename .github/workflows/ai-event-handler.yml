name: AI Event Handler

on:
  issues:
    types: [opened, edited, labeled, milestoned]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: read

jobs:
  handle-event:
    # Ejecutar si:
    # 1. Nueva issue, editada o etiquetada (especialmente con ai-agent)
    # 2. Comentario en PR automatizada
    # 3. Disparo manual
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.issue.labels.*.name, 'automated-pr')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: "PVT_kwHOAA562c4BOtC-"
      STATUS_FIELD_ID: "PVTSSF_lAHOAA562c4BOtC-zg9U7KE"
      GITHUB_TOKEN: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}
    outputs:
      issue_number: ${{ steps.info.outputs.num }}
      is_comment: ${{ steps.info.outputs.is_comment }}
      comment_body: ${{ steps.info.outputs.comment_body }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Extract Info
        id: info
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "num=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "is_comment=true" >> $GITHUB_OUTPUT
            echo "comment_body=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
          else
            NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
            
            # Si no hay número (disparo por etiqueta o edición sin número claro)
            if [ -z "$NUM" ] || [ "$NUM" == "null" ]; then
              echo "No explicit issue number. Running auto-pick..."
              NUM=$(node .github/scripts/workflow-utils.js auto-pick)
            fi
            
            echo "num=$NUM" >> $GITHUB_OUTPUT
            echo "is_comment=false" >> $GITHUB_OUTPUT
            
            if [ ! -z "$NUM" ] && [ "$NUM" != "null" ]; then
              # Asegurar que la issue está en el proyecto
              node .github/scripts/workflow-utils.js add-to-project "https://github.com/${{ github.repository }}/issues/$NUM"
            fi
          fi

  run-engine:
    needs: handle-event
    if: needs.handle-event.outputs.issue_number != '' && needs.handle-event.outputs.issue_number != 'null'
    uses: ./.github/workflows/ai-engine.yml
    with:
      issue_number: ${{ needs.handle-event.outputs.issue_number }}
      is_comment: ${{ needs.handle-event.outputs.is_comment == 'true' }}
      comment_body: ${{ needs.handle-event.outputs.comment_body }}
    secrets:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PROJECT_PAT: ${{ secrets.PROJECT_PAT }}
