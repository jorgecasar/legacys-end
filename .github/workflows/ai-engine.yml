name: AI Engine

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
      is_comment:
        required: false
        type: boolean
        default: false
      comment_body:
        required: false
        type: string
    secrets:
      GEMINI_API_KEY:
        required: true
      PROJECT_PAT:
        required: false

jobs:
  develop:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: "PVT_kwHOAA562c4BOtC-"
      PROJECT_NUMBER: 2
      STATUS_FIELD_ID: "PVTSSF_lAHOAA562c4BOtC-zg9U7KE"
      ISSUE_NUM: ${{ inputs.issue_number }}
      GITHUB_TOKEN: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check Dependencies
        run: |
          node .github/scripts/workflow-utils.js check-deps $ISSUE_NUM || {
            echo "::error::Blocked by dependency"
            exit 1
          }

      - name: Triage Task
        id: triage
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "Determining best model for task..."
          MODEL_ID=$(node .github/scripts/workflow-utils.js triage-task $ISSUE_NUM)
          echo "Selected Model: $MODEL_ID"
          echo "model_id=$MODEL_ID" >> $GITHUB_OUTPUT

      - name: Update Status to In Progress
        run: |
          if [ "${{ inputs.is_comment }}" == "true" ]; then
            BRANCH_NAME=$(gh pr view "$ISSUE_NUM" --json headRefName -q .headRefName)
          else
            BRANCH_NAME="ai-fix/issue-$ISSUE_NUM"
          fi
          node .github/scripts/workflow-utils.js set-status $ISSUE_NUM IN_PROGRESS "$BRANCH_NAME"

      - name: Configure Git
        run: |
          git config --global user.name "AI Agent"
          git config --global user.email "ai-agent@users.noreply.github.com"

      - name: Run AI Agent
        id: run-agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Preparar Rama
          BRANCH_NAME="ai-fix/issue-$ISSUE_NUM"
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
          fi
          
          git fetch origin main
          git rebase origin/main || { echo "Rebase failed"; exit 1; }

          # 2. Ejecutar Motor Nativo
          PRIMARY_MODEL="${{ steps.triage.outputs.model_id }}"
          # Fallback agresivo entre series
          MODELS_TO_TRY=("$PRIMARY_MODEL" "gemini-3-flash-preview" "gemini-2.5-pro" "gemini-2.5-flash-lite")
          
          AGENT_SUCCESS=false
          FINAL_MODEL=""
          for CURRENT_MODEL in "${MODELS_TO_TRY[@]}"; do
            echo "ðŸš€ Intentando con modelo: $CURRENT_MODEL"
            FINAL_MODEL=$CURRENT_MODEL
            if node .github/scripts/ai-developer.js "$CURRENT_MODEL" "$ISSUE_NUM"; then
              AGENT_SUCCESS=true
              break
            else
              echo "âš ï¸ Error con $CURRENT_MODEL. Enfriando 30s..."
              sleep 30
            fi
          done
          
          echo "final_model=$FINAL_MODEL" >> $GITHUB_OUTPUT

          # 3. Finalizar Commit
          if [ "$AGENT_SUCCESS" = true ]; then
            if git diff --quiet; then
              echo "status=no_changes" >> $GITHUB_OUTPUT
            else
              git add .
              COMMIT_MSG="feat: solve issue #$ISSUE_NUM"
              if ! git diff --staged --name-only | grep -qE "^(src/|public/|index\.html|package\.json|vite\.config\.js)"; then
                COMMIT_MSG="$COMMIT_MSG [skip ci]"
              fi
              git commit -m "$COMMIT_MSG" --no-verify
              echo "status=success" >> $GITHUB_OUTPUT
              git push origin HEAD --force-with-lease
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Update Pull Request
        if: steps.run-agent.outputs.status == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai-fix/issue-${{ inputs.issue_number }}
          base: main
          title: "ðŸ¤– AI Solution: Issue #${{ inputs.issue_number }}"
          body: "Automatically generated by AI Agent using Native Motor (Token Efficient)."
          labels: automated-pr

      - name: Update Project Status
        if: always()
        run: |
          if [ "${{ steps.run-agent.outputs.status }}" == "success" ]; then
            node .github/scripts/workflow-utils.js set-status $ISSUE_NUM REVIEW "ai-fix/issue-$ISSUE_NUM"
          else
            node .github/scripts/workflow-utils.js set-status $ISSUE_NUM PAUSED_429 "ai-fix/issue-$ISSUE_NUM"
          fi