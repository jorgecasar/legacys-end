name: AI Engine

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
      is_comment:
        required: false
        type: boolean
        default: false
      comment_body:
        required: false
        type: string
    secrets:
      PROJECT_PAT:
        required: false
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: false
      GCP_SERVICE_ACCOUNT:
        required: false

jobs:
  develop:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    env:
      PROJECT_ID: "PVT_kwHOAA562c4BOtC-"
      PROJECT_NUMBER: 2
      STATUS_FIELD_ID: "PVTSSF_lAHOAA562c4BOtC-zg9U7KE"
      ISSUE_NUM: ${{ inputs.issue_number }}
      GITHUB_TOKEN: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}
      GEMINI_USE_ADC: "true"
      GOOGLE_CLOUD_PROJECT: "legacys-end"
      GCP_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SA: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Authenticate to Google Cloud
        if: env.GEMINI_USE_ADC == 'true' && env.GCP_PROVIDER != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_PROVIDER }}
          service_account: ${{ env.GCP_SA }}

      - name: Set up Cloud SDK
        if: env.GEMINI_USE_ADC == 'true' && env.GCP_SA != ''
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify ADC
        run: |
          if [ ! -z "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "âœ… GOOGLE_APPLICATION_CREDENTIALS is set."
          else
            echo "â„¹ï¸ ADC not configured, relying on local environment or keys."
          fi

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Check Dependencies
        run: |
          node .github/scripts/workflow-utils.js check-deps $ISSUE_NUM || {
            echo "::error::Blocked by dependency"
            exit 1
          }

      - name: Triage Task
        id: triage
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "Determining best model for task..."
          MODEL_ID=$(node .github/scripts/workflow-utils.js triage-task $ISSUE_NUM)
          echo "Selected Model: $MODEL_ID"
          echo "model_id=$MODEL_ID" >> $GITHUB_OUTPUT

      - name: Update Status to In Progress
        run: |
          BRANCH_NAME="ai-fix/issue-$ISSUE_NUM"
          node .github/scripts/workflow-utils.js set-status $ISSUE_NUM IN_PROGRESS "$BRANCH_NAME"

      - name: Configure Git
        run: |
          git config --global user.name "AI Agent"
          git config --global user.email "ai-agent@users.noreply.github.com"

      - name: Run Gemini CLI Engine
        id: run-agent
        env:
          GEMINI_USE_ADC: "true"
          GOOGLE_CLOUD_PROJECT: "legacys-end"
        run: |
          # 1. Preparar Rama
          BRANCH_NAME="ai-fix/issue-$ISSUE_NUM"
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
          fi
          
          git fetch origin main
          git rebase origin/main || { echo "Rebase failed"; exit 1; }

          # 2. Ejecutar comando gemini
          MODEL_ID="${{ steps.triage.outputs.model_id }}"
          if node .github/scripts/ai-developer.js "$MODEL_ID" "$ISSUE_NUM"; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Finalize Commit
        if: steps.run-agent.outputs.status == 'success'
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .
            COMMIT_MSG="feat: solve issue #$ISSUE_NUM"
            if ! git diff --staged --name-only | grep -qE "^(src/|public/|index\.html|package\.json|vite\.config\.js)"; then
              COMMIT_MSG="$COMMIT_MSG [skip ci]"
            fi
            git commit -m "$COMMIT_MSG" --no-verify
            git push origin HEAD --force-with-lease
          fi

      - name: Update Pull Request
        if: steps.run-agent.outputs.status == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai-fix/issue-${{ inputs.issue_number }}
          base: main
          title: "ðŸ¤– AI Solution: Issue #${{ inputs.issue_number }}"
          body: "Automatically generated by Gemini CLI Agent (AI Pro Quotas)."
          labels: automated-pr

      - name: Update Project Status
        if: always()
        run: |
          if [ "${{ steps.run-agent.outputs.status }}" == "success" ]; then
            node .github/scripts/workflow-utils.js set-status $ISSUE_NUM REVIEW "ai-fix/issue-$ISSUE_NUM"
          else
            node .github/scripts/workflow-utils.js set-status $ISSUE_NUM PAUSED_429 "ai-fix/issue-$ISSUE_NUM"
          fi
