name: AI Engine

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
      is_comment:
        required: false
        type: boolean
        default: false
      comment_body:
        required: false
        type: string
    secrets:
      PROJECT_PAT:
        required: false
      GEMINI_API_KEY:
        required: true

jobs:
  develop:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    env:
      PROJECT_ID: "PVT_kwHOAA562c4BOtC-"
      PROJECT_NUMBER: 2
      STATUS_FIELD_ID: "PVTSSF_lAHOAA562c4BOtC-zg9U7KE"
      ISSUE_NUM: ${{ inputs.issue_number }}
      GITHUB_TOKEN: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Check Dependencies
        run: |
          node .github/scripts/workflow-utils.js check-deps $ISSUE_NUM || {
            echo "::error::Blocked by dependency"
            exit 1
          }

      - name: Triage Task
        id: triage
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: 'gemini-2.5-flash-lite'
          prompt: |
            Identify the best Gemini model ID for the task: "${{ github.event.issue.title }}".
            Context labels: ${{ join(github.event.issue.labels.*.name, ', ') }}.
            Available options: gemini-3-pro-preview, gemini-3-flash-preview, gemini-2.5-flash-lite.
            Return ONLY the model ID string.

      - name: Set Selected Model
        id: selected-model
        run: |
          # Extract only the model ID from the response (handling potential noise)
          MODEL_ID=$(echo "${{ steps.triage.outputs.text }}" | grep -oE "gemini-[a-zA-Z0-9.-]+" | head -n 1)
          if [ -z "$MODEL_ID" ]; then
            MODEL_ID="gemini-2.5-flash-lite"
          fi
          echo "Selected Model: $MODEL_ID"
          echo "model_id=$MODEL_ID" >> $GITHUB_OUTPUT

      - name: Update Status to In Progress
        run: |
          BRANCH_NAME="ai-fix/issue-$ISSUE_NUM"
          node .github/scripts/workflow-utils.js set-status $ISSUE_NUM IN_PROGRESS "$BRANCH_NAME"

      - name: Configure Git
        run: |
          git config --global user.name "AI Agent"
          git config --global user.email "ai-agent@users.noreply.github.com"

      - name: Run Gemini CLI Engine
        id: run-agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Preparar Rama
          BRANCH_NAME="ai-fix/issue-$ISSUE_NUM"
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
          fi
          
          git fetch origin main
          git rebase origin/main || { echo "Rebase failed"; exit 1; }

          # 2. Ejecutar comando gemini (La acciÃ³n ya instalÃ³ la CLI)
          MODEL_ID="${{ steps.selected-model.outputs.model_id }}"
          if node .github/scripts/ai-developer.js "$MODEL_ID" "$ISSUE_NUM"; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Finalize Commit
        if: steps.run-agent.outputs.status == 'success'
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .
            COMMIT_MSG="feat: solve issue #$ISSUE_NUM"
            if ! git diff --staged --name-only | grep -qE "^(src/|public/|index\.html|package\.json|vite\.config\.js)"; then
              COMMIT_MSG="$COMMIT_MSG [skip ci]"
            fi
            git commit -m "$COMMIT_MSG" --no-verify
            git push origin HEAD --force-with-lease
          fi

      - name: Update Pull Request
        if: steps.run-agent.outputs.status == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai-fix/issue-${{ inputs.issue_number }}
          base: main
          title: "ðŸ¤– AI Solution: Issue #${{ inputs.issue_number }}"
          body: "Automatically generated by Gemini CLI Agent (AI Pro Quotas)."
          labels: automated-pr

      - name: Update Project Status
        if: always()
        run: |
          if [ "${{ steps.run-agent.outputs.status }}" == "success" ]; then
            node .github/scripts/workflow-utils.js set-status $ISSUE_NUM REVIEW "ai-fix/issue-$ISSUE_NUM"
          else
            node .github/scripts/workflow-utils.js set-status $ISSUE_NUM PAUSED_429 "ai-fix/issue-$ISSUE_NUM"
          fi